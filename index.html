<!DOCTYPE HTML>
<html>

	<head>

		<style type="text/css">

			table {
				border: 1px solid black;
			}

			.frameHeaderCell {
				border: 1px solid blue;
				text-align: center;
				font-weight: bold;
			}

			.pointCell {
				border: 1px solid blue;
				padding: 20px;
			}

		</style>

		<script language="javascript">

			var _activeFrame = 0;
			var _activeThrow = 0;

			var _disabledColor = "gray";
			var _activeColor = "red";
			var _pastColor = "white";

			function on_load ( )
			{

				var pointCellElements = document.querySelectorAll(".pointCell");

				pointCellElements.forEach(function(pointCell) {
					
					pointCell.addEventListener("click", function() {
						
						point_cell_clicked ( this );

					});

				});


				set_active_frame ( _activeFrame, _activeThrow, true );


				var buttons = document.querySelectorAll("button");
				buttons.forEach(function(btn) {
					btn.addEventListener("click", function() {

						var val = btn.innerHTML;

						document.getElementById(_activeFrame + "" + _activeThrow).innerHTML = val;
						if ( val == "X" )
						{
							if ( (is_next_throw_disabled() === true) && _activeFrame < 9 )
							{
								advance_to_next_throw ( );
							}
						}
						else if ( val == "/" )
						{

						}
						else
						{

						}


						if ( is_next_throw_disabled() === true )
						{
							advance_to_next_throw ( );
						}


						calculate_score ( );

					});
				});

			}

			function set_active_frame ( frame, ballThrow, disableFollowingFrames )
			{

				var oldID = _activeFrame + "" + _activeThrow;
				document.getElementById(oldID).style.backgroundColor = _pastColor;

				var newID = frame + "" + ballThrow;
				document.getElementById(newID).style.backgroundColor = _activeColor;

				if ( ballThrow === 0 )
				{
					document.getElementById("cmd_strike").style.visibility = "visible";
					document.getElementById("cmd_spare").style.visibility = "hidden";

					for (var index = 1; index <= 9; index++ )
					{
						document.getElementById("cmd_" + index).style.visibility = "visible";
					}
				}
				else
				{
					if ( frame < 9 )
					{
						document.getElementById("cmd_strike").style.visibility = "hidden";
						document.getElementById("cmd_spare").style.visibility = "visible";

						var previousThrowValue = document.getElementById(frame + "" + parseInt(ballThrow-1)).innerHTML;

						if ( previousThrowValue != "." )
						{
							previousThrowValue = 10 - parseInt(previousThrowValue);
							for (var index = 1; index <= 9; index++ )
							{
								if ( index < previousThrowValue )
								{
									document.getElementById("cmd_" + index).style.visibility = "visible";
								}
								else
								{
									document.getElementById("cmd_" + index).style.visibility = "hidden";
								}
							}
						}
						else
						{
							for (var index = 1; index <= 9; index++ )
							{
								document.getElementById("cmd_" + index).style.visibility = "visible";
							}
						}

						console.log ( "Previous", previousThrowValue );
					}
					else
					{
						document.getElementById("cmd_strike").style.visibility = "visible";	// FIXME: Wrong!
						document.getElementById("cmd_spare").style.visibility = "visible";
					}
				}				


				if ( disableFollowingFrames === true )
				{

					if ( frame < 9 )
					{
						if ( ballThrow === 0 )
						{
							document.getElementById(frame + "1").style.backgroundColor = _disabledColor;
						}
					}
					else
					{
						if ( ballThrow === 0 )
						{
							document.getElementById(frame + "1").style.backgroundColor = _disabledColor;
							document.getElementById(frame + "2").style.backgroundColor = _disabledColor;
						}
						else if ( ballThrow === 1 )
						{
							document.getElementById(frame + "2").style.backgroundColor = _disabledColor;
						}
					}

					for ( var index = frame + 1; index < 10; index++ )
					{
						disable_frame ( index );
					}
				}

				_activeFrame = frame;
				_activeThrow = ballThrow;
			}

			function disable_frame ( frame )
			{

				document.getElementById(frame + "0").style.backgroundColor = _disabledColor;
				document.getElementById(frame + "1").style.backgroundColor = _disabledColor;

				if ( frame === 9 )
				{
					document.getElementById(frame + "2").style.backgroundColor = _disabledColor;
				}
			}

			function point_cell_clicked ( pointCell )
			{

				var pointCellFrame = parseInt(pointCell.id.charAt(0));
				var pointCellThrow = parseInt(pointCell.id.charAt(1));

				if ( pointCell.style.backgroundColor == _disabledColor )
				{
					
				}
				else if ( pointCell.style.backgroundColor == _activeColor )
				{

				}
				else
				{
					set_active_frame ( pointCellFrame, pointCellThrow, false );
				}				

			}

			function is_next_throw_disabled ( )
			{
				var nextFrame = _activeFrame;
				var nextThrow = _activeThrow;

				nextThrow++;
				if ( (nextThrow == 2) && (nextFrame < 9) )
				{
					nextThrow = 0;
					nextFrame++;
				}
				else if ( nextFrame == 9 )
				{
					if ( nextThrow == 3 )
					{
						nextThrow--;
					}
				}

				return (document.getElementById(nextFrame + "" + nextThrow).style.backgroundColor == _disabledColor);
			}


			function advance_to_next_throw ( )
			{
				var nextFrame = _activeFrame;
				var nextThrow = _activeThrow;

				nextThrow++;
				if ( (nextThrow == 2) && (nextFrame < 9) )
				{
					nextThrow = 0;
					nextFrame++;
				}
				else if ( nextFrame == 9 )
				{
					if ( nextThrow == 3 )
					{
						nextThrow--;
					}
				}

				set_active_frame ( nextFrame, nextThrow );
			}


			function calculate_score ( )
			{

				var score = 0;

				for ( var frameIndex = 0; frameIndex <= 9; frameIndex++ )
				{
				

					var value = document.getElementById(frameIndex + "0").innerHTML;
					if ( value == "X" )
					{
						value = 10;
					}
					else if ( value == "/" )
					{
						value = 10;
					}
					else if ( value == "" || value == "." )
					{
						value = 0;
					}
					else
					{
						value = parseInt(value);
					}

					score += value;

					isDisabled = (document.getElementById(frameIndex + "1").style.backgroundColor == _disabledColor);

					if ( isDisabled === false )
					{
						var value = document.getElementById(frameIndex + "1").innerHTML;
						if ( value == "X" )
						{
							value = 10;
						}
						else if ( value == "/" )
						{
							value = 10;
						}
						else if ( value == "" || value == "." )
						{
							value = 0;
						}
						else
						{
							value = parseInt(value);
						}

						score += value;
					}



					if ( frameIndex == 9 )
					{
						isDisabled = (document.getElementById(frameIndex + "2").style.backgroundColor == _disabledColor);

						if ( isDisabled === false )
						{
							var value = document.getElementById(frameIndex + "2").innerHTML;
							if ( value == "X" )
							{
								value = 10;
							}
							else if ( value == "/" )
							{
								value = 10;
							}
							else if ( value == "" || value == "." )
							{
								value = 0;
							}
							else
							{
								value = parseInt(value);
							}

							score += value;
						}
					}

					console.log ( "Score", score );
				}

			}


		</script>

	</head>

	<body onload="on_load();">

		<table>
			<tr>
				<td class="frameHeaderCell" colspan="2">1</td>
				<td class="frameHeaderCell" colspan="2">2</td>
				<td class="frameHeaderCell" colspan="2">3</td>
				<td class="frameHeaderCell" colspan="2">4</td>
				<td class="frameHeaderCell" colspan="2">5</td>
				<td class="frameHeaderCell" colspan="2">6</td>
				<td class="frameHeaderCell" colspan="2">7</td>
				<td class="frameHeaderCell" colspan="2">8</td>
				<td class="frameHeaderCell" colspan="2">9</td>
				<td class="frameHeaderCell" colspan="3">10</td>
			</tr>
			<tr>
				<td class="pointCell" id="00" disabled></td><td class="pointCell" id="01"></td>
				<td class="pointCell" id="10"></td><td class="pointCell" id="11"></td>
				<td class="pointCell" id="20"></td><td class="pointCell" id="21"></td>
				<td class="pointCell" id="30"></td><td class="pointCell" id="31"></td>
				<td class="pointCell" id="40"></td><td class="pointCell" id="41"></td>
				<td class="pointCell" id="50"></td><td class="pointCell" id="51"></td>
				<td class="pointCell" id="60"></td><td class="pointCell" id="61"></td>
				<td class="pointCell" id="70"></td><td class="pointCell" id="71"></td>
				<td class="pointCell" id="80"></td><td class="pointCell" id="81"></td>
				<td class="pointCell" id="90"></td><td class="pointCell" id="91"></td><td class="pointCell" id="92"></td>
			</tr>
		</table>

		<br />

		<table border="1">
			<tr>
				<td><button type="button" id="cmd_1">1</button></td>
				<td><button type="button" id="cmd_2">2</button></td>
				<td><button type="button" id="cmd_3">3</button></td>
			</tr>
			<tr>
				<td><button type="button" id="cmd_4">4</button></td>
				<td><button type="button" id="cmd_5">5</button></td>
				<td><button type="button" id="cmd_6">6</button></td>
			</tr>
			<tr>
				<td><button type="button" id="cmd_7">7</button></td>
				<td><button type="button" id="cmd_8">8</button></td>
				<td><button type="button" id="cmd_9">9</button></td>
			</tr>
			<tr>
				<td><button type="button" id="cmd_spare">/</button></td>
				<td><button type="button" id="cmd_strike">X</button></td>
				<td><button type="button" id="cmd_gutter">.</button></td>
			</tr>
		</table>

	</body>

</html>
